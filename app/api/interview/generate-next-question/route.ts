import { NextRequest, NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'
import * as admin from 'firebase-admin'
import { initializeFirebaseAdmin } from '@/src/lib/firebase-admin'

// Initialize Firebase Admin SDK
export async function POST(request: NextRequest) {
  try {
    await initializeFirebaseAdmin()
    const adminDb = admin.firestore()
    const {
      conversationHistory,
      remainingQuestions,
      interviewPurpose,
      targetAudience,
      mediaType,
      objective,
      knowledgeBaseIds,
      intervieweeName,
      intervieweeCompany,
      intervieweeTitle,
      intervieweeDepartment,
      intervieweeType,
      confirmNameAtInterview,
      confirmCompanyAtInterview,
      confirmTitleAtInterview,
      confirmDepartmentAtInterview,
      introductionMessage,
      interviewerName
    } = await request.json()

    if (!conversationHistory || !Array.isArray(conversationHistory)) {
      return NextResponse.json(
        { error: 'ä¼šè©±å±¥æ­´ãŒå¿…è¦ã§ã™' },
        { status: 400 }
      )
    }

    const geminiApiKey = process.env.GEMINI_API_KEY
    if (!geminiApiKey) {
      return NextResponse.json(
        { error: 'Gemini API KeyãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“' },
        { status: 500 }
      )
    }

    const genAI = new GoogleGenerativeAI(geminiApiKey)

    // Fetch the master direction prompt
    let directionPromptContext = ''
    try {
      const settingsRef = adminDb.collection('systemSettings').doc('appDirection')
      const settingsDoc = await settingsRef.get()
      if (settingsDoc.exists) {
        directionPromptContext = settingsDoc.data()?.directionPrompt || ''
      }
    } catch (error) {
      console.warn('âš ï¸ Error loading app direction prompt:', error)
      // Continue without the master prompt if it fails
    }

    // ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å¯¾è©±æ‰‹æ³•ã®æƒ…å ±ã‚’å–å¾—
    // é‡è¦: ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è‡ªå‹•å–å¾—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‹ã‚‰é€ä¿¡ã•ã‚Œãªãã¦ã‚‚å–å¾—ï¼‰
    let skillKnowledgeContext = ''

    // 1. ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’è‡ªå‹•å–å¾—ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã®ã¿ï¼‰
    if (adminDb) {
      try {
        // ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’ã‚¯ã‚¨ãƒªã§å–å¾—ï¼ˆuseForDialogue === true ã¾ãŸã¯æœªè¨­å®šã®ã‚‚ã®ï¼‰
        const skillKBQuery = adminDb
          .collection('knowledgeBases')
          .where('type', '==', 'skill')
          .limit(10) // æœ€å¤§10å€‹ã¾ã§å–å¾—

        const skillKBSnapshot = await skillKBQuery.get()

        const skillKBDocs = await Promise.all(
          skillKBSnapshot.docs.map(async (doc) => {
            const kbData = doc.data()

            // å‰Šé™¤æ¸ˆã¿ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (kbData?.deleted === true) {
              return null
            }

            // å¯¾è©±è¡“ã§ä½¿ç”¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (kbData?.useForDialogue === false) {
              return null
            }

            // ç·¨é›†æ™‚ã®ã¿ä½¿ç”¨ã®ã‚¹ã‚­ãƒ«ã¯é™¤å¤–
            if (kbData?.isEditOnly) {
              return null
            }

            // ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®chunksã‚’å–å¾—
            let chunksText = ''
            try {
              const chunksSnapshot = await adminDb
                .collection('knowledgeBases')
                .doc(doc.id)
                .collection('chunks')
                .limit(50)
                .get()

              if (!chunksSnapshot.empty) {
                chunksText = chunksSnapshot.docs
                  .map(chunkDoc => chunkDoc.data().text || '')
                  .filter(text => text.length > 0)
                  .join('\n\n')
              }
            } catch (chunksError) {
              // æ©Ÿå¯†ä¿è­·ã®ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¯å‡ºåŠ›ã—ãªã„
              console.warn('âš ï¸ Error loading chunks: [details masked]')
            }

            return {
              summary: kbData?.summary || '',
              usageGuide: kbData?.usageGuide || '',
              fileName: kbData?.fileName || '',
              chunks: chunksText,
            }
          })
        )

        const validSkillKBs = skillKBDocs.filter(kb => kb !== null)

        if (validSkillKBs.length > 0) {
          skillKnowledgeContext = validSkillKBs.map(kb => {
            let context = `ã€${kb?.fileName}ã€‘\næ¦‚è¦: ${kb?.summary}\næ´»ç”¨æ–¹æ³•: ${kb?.usageGuide}`
            if (kb?.chunks && kb.chunks.length > 0) {
              context += `\n\nã€å¯¾è©±è¨­è¨ˆãƒ»è³ªå•è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€‘\n${kb.chunks.substring(0, 10000)}`
            }
            return context
          }).join('\n\n')
        }
      } catch (skillKBError) {
        // æ©Ÿå¯†ä¿è­·ã®ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã¯å‡ºåŠ›ã—ãªã„
        console.warn('âš ï¸ Error loading skill knowledge bases: [details masked]')
      }
    }

    const model = genAI.getGenerativeModel({
      model: 'gemini-2.0-flash',
      generationConfig: {
        temperature: 0.7, // å°‘ã—æŠ‘ãˆã¦ä¸€è²«æ€§ã‚’ä¿ã¤
        maxOutputTokens: 500,
      },
    })

    // ä¼šè©±å±¥æ­´ã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
    const conversationText = conversationHistory
      .map((msg: any) => {
        if (msg.role === 'interviewer') {
          return `ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼: ${msg.content}`
        } else if (msg.role === 'interviewee') {
          return `å›ç­”è€…: ${msg.content}`
        }
        return ''
      })
      .filter((text: string) => text.length > 0)
      .join('\n')

    // æ®‹ã‚Šã®è³ªå•ãƒªã‚¹ãƒˆã‚’ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
    const remainingQuestionsText = remainingQuestions && remainingQuestions.length > 0
      ? remainingQuestions.map((q: any, idx: number) => `${idx + 1}. ${typeof q === 'string' ? q : q.text || ''}`).join('\n')
      : 'ãªã—'

    // ä¼šè©±å±¥æ­´ãŒç©ºã®å ´åˆï¼ˆæœ€åˆã®è³ªå•ï¼‰ã§ã€ç¢ºèªãŒå¿…è¦ãªå ´åˆã¯ç¢ºèªã™ã‚‹è³ªå•ã‚’ç”Ÿæˆ
    const isFirstQuestion = conversationHistory.length === 0 ||
      (conversationHistory.length === 1 && conversationHistory[0].role === 'interviewer')

    let confirmationContext = ''
    if (isFirstQuestion) {
      // ç¢ºèªãŒå¿…è¦ãªé …ç›®ã‚’åé›†
      const needsConfirmation: string[] = []
      const confirmedParts: string[] = []

      // åå‰ã®ç¢ºèª
      if (confirmNameAtInterview) {
        needsConfirmation.push('ãŠåå‰')
      } else if (intervieweeName) {
        confirmedParts.push(intervieweeName)
      }

      // ä¼šç¤¾åã®ç¢ºèªï¼ˆä¼æ¥­ãƒ»å›£ä½“ã®å ´åˆã®ã¿ï¼‰
      if (intervieweeType === 'company') {
        if (confirmCompanyAtInterview) {
          needsConfirmation.push('ä¼šç¤¾åãƒ»å›£ä½“å')
        } else if (intervieweeCompany) {
          confirmedParts.push(intervieweeCompany)
        }

        // éƒ¨ç½²åã®ç¢ºèª
        if (confirmDepartmentAtInterview) {
          needsConfirmation.push('éƒ¨ç½²å')
        } else if (intervieweeDepartment) {
          confirmedParts.push(intervieweeDepartment)
        }

        // å½¹è·åã®ç¢ºèª
        if (confirmTitleAtInterview) {
          needsConfirmation.push('å½¹è·å')
        } else if (intervieweeTitle) {
          confirmedParts.push(intervieweeTitle)
        }
      }

      // æœ€åˆã®è³ªå•ã®æ§‹æˆã‚’æŒ‡å®šï¼ˆæŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ã€åå‰ç¢ºèªã‚’å«ã‚ã‚‹ï¼‰
      const actualInterviewerName = interviewerName || 'ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼'
      let firstQuestionParts: string[] = []
      firstQuestionParts.push('1. æŒ¨æ‹¶ï¼šã€Œæœ¬æ—¥ã¯ãŠæ™‚é–“ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã€')
      firstQuestionParts.push(`2. è‡ªå·±ç´¹ä»‹ï¼šã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®åå‰ã‚’åä¹—ã‚‹ï¼ˆå®Ÿéš›ã®åå‰ã€Œ${actualInterviewerName}ã€ã‚’ä½¿ç”¨ã€‚ã€Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã€ã¨ã„ã†è¡¨ç¾ã¯ä½¿ã‚ãªã„ï¼‰`)
      firstQuestionParts.push(`   - ä¾‹ï¼šã€Œç§ã€${actualInterviewerName}ã¨ç”³ã—ã¾ã™ã€‚ã€`)

      // ç¢ºèªãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚‹å ´åˆ
      if (needsConfirmation.length > 0) {
        const needsConfirmationText = needsConfirmation.join('ãƒ»')
        firstQuestionParts.push(`3. ç›¸æ‰‹æ–¹ã®åå‰ç¢ºèªï¼šã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€${needsConfirmationText}ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã‚‚ã—è£œè¶³ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€`)
        confirmationContext = `ã€é‡è¦ã€‘æœ€åˆã®è³ªå•ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ§‹æˆã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š\n${firstQuestionParts.join('\n')}\n\n4. æœ¬é¡Œã¸ã®å°å…¥ï¼šã€Œãã‚Œã§ã¯ã€æ—©é€Ÿã§ã™ãŒ...ã€ã¨ã„ã†å½¢ã§æœ¬é¡Œã®è³ªå•ã¸è‡ªç„¶ã«ç¹‹ã’ã‚‹\n\n**æ³¨æ„**ï¼š
- å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã®èª¬æ˜ï¼‰ã¯ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„
- æŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ã€åå‰ç¢ºèªã¯å¿…ãšå«ã‚ã¦ãã ã•ã„
- è‡ªå·±ç´¹ä»‹ã§ã¯ã€å¿…ãšå®Ÿéš›ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼åã€Œ${actualInterviewerName}ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã€Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã€ã¨ã„ã†è¡¨ç¾ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„
- ä¾‹ï¼šã€Œç§ã€${actualInterviewerName}ã¨ç”³ã—ã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ã€å®Ÿéš›ã®åå‰ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„`
      }
      // ç¢ºèªãŒå¿…è¦ãªé …ç›®ãŒãªãã€æƒ…å ±ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®æƒ…å ±ã‚’ç¢ºèª
      else if (confirmedParts.length > 0) {
        if (intervieweeType === 'company' && intervieweeCompany) {
          const companyPart = intervieweeCompany
          const departmentPart = intervieweeDepartment ? `${intervieweeDepartment}ã®` : ''
          const titlePart = intervieweeTitle ? `${intervieweeTitle}ã®` : ''
          const namePart = intervieweeName
          firstQuestionParts.push(`3. ç›¸æ‰‹æ–¹ã®åå‰ç¢ºèªï¼šã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€${companyPart}ã®${departmentPart}${titlePart}${namePart}ã•ã‚“ã§é–“é•ã„ã”ã–ã„ã¾ã›ã‚“ã‹ï¼Ÿã‚‚ã—è£œè¶³ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€`)
          confirmationContext = `ã€é‡è¦ã€‘æœ€åˆã®è³ªå•ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ§‹æˆã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š\n${firstQuestionParts.join('\n')}\n\n4. æœ¬é¡Œã¸ã®å°å…¥ï¼šã€Œãã‚Œã§ã¯ã€æ—©é€Ÿã§ã™ãŒ...ã€ã¨ã„ã†å½¢ã§æœ¬é¡Œã®è³ªå•ã¸è‡ªç„¶ã«ç¹‹ã’ã‚‹\n\n**æ³¨æ„**ï¼š
- å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã®èª¬æ˜ï¼‰ã¯ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„
- æŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ã€åå‰ç¢ºèªã¯å¿…ãšå«ã‚ã¦ãã ã•ã„
- è‡ªå·±ç´¹ä»‹ã§ã¯ã€å¿…ãšå®Ÿéš›ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼åã€Œ${actualInterviewerName}ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã€Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã€ã¨ã„ã†è¡¨ç¾ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„
- ä¾‹ï¼šã€Œç§ã€${actualInterviewerName}ã¨ç”³ã—ã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ã€å®Ÿéš›ã®åå‰ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„`
        } else if (intervieweeType === 'individual' && intervieweeName) {
          const titlePart = intervieweeTitle ? `${intervieweeTitle}ã®` : ''
          firstQuestionParts.push(`3. ç›¸æ‰‹æ–¹ã®åå‰ç¢ºèªï¼šã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€${titlePart}${intervieweeName}ã•ã‚“ã§é–“é•ã„ã”ã–ã„ã¾ã›ã‚“ã‹ï¼Ÿã‚‚ã—è£œè¶³ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ãŠé¡˜ã„ã—ã¾ã™ã€‚ã€`)
          confirmationContext = `ã€é‡è¦ã€‘æœ€åˆã®è³ªå•ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ§‹æˆã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š\n${firstQuestionParts.join('\n')}\n\n4. æœ¬é¡Œã¸ã®å°å…¥ï¼šã€Œãã‚Œã§ã¯ã€æ—©é€Ÿã§ã™ãŒ...ã€ã¨ã„ã†å½¢ã§æœ¬é¡Œã®è³ªå•ã¸è‡ªç„¶ã«ç¹‹ã’ã‚‹\n\n**æ³¨æ„**ï¼š
- å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã®èª¬æ˜ï¼‰ã¯ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„
- æŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ã€åå‰ç¢ºèªã¯å¿…ãšå«ã‚ã¦ãã ã•ã„
- è‡ªå·±ç´¹ä»‹ã§ã¯ã€å¿…ãšå®Ÿéš›ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼åã€Œ${actualInterviewerName}ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã€Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã€ã¨ã„ã†è¡¨ç¾ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„
- ä¾‹ï¼šã€Œç§ã€${actualInterviewerName}ã¨ç”³ã—ã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ã€å®Ÿéš›ã®åå‰ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„`
        } else {
          firstQuestionParts.push('3. ç›¸æ‰‹æ–¹ã®åå‰ç¢ºèªï¼šã€ŒãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã€')
          confirmationContext = `ã€é‡è¦ã€‘æœ€åˆã®è³ªå•ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ§‹æˆã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š\n${firstQuestionParts.join('\n')}\n\n4. æœ¬é¡Œã¸ã®å°å…¥ï¼šã€Œãã‚Œã§ã¯ã€æ—©é€Ÿã§ã™ãŒ...ã€ã¨ã„ã†å½¢ã§æœ¬é¡Œã®è³ªå•ã¸è‡ªç„¶ã«ç¹‹ã’ã‚‹\n\n**æ³¨æ„**ï¼š
- å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã®èª¬æ˜ï¼‰ã¯ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„
- æŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ã€åå‰ç¢ºèªã¯å¿…ãšå«ã‚ã¦ãã ã•ã„
- è‡ªå·±ç´¹ä»‹ã§ã¯ã€å¿…ãšå®Ÿéš›ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼åã€Œ${actualInterviewerName}ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã€Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã€ã¨ã„ã†è¡¨ç¾ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„
- ä¾‹ï¼šã€Œç§ã€${actualInterviewerName}ã¨ç”³ã—ã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ã€å®Ÿéš›ã®åå‰ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„`
        }
      } else {
        firstQuestionParts.push('3. ç›¸æ‰‹æ–¹ã®åå‰ç¢ºèªï¼šã€ŒãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã€')
        confirmationContext = `ã€é‡è¦ã€‘æœ€åˆã®è³ªå•ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ§‹æˆã§ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š\n${firstQuestionParts.join('\n')}\n\n4. æœ¬é¡Œã¸ã®å°å…¥ï¼šã€Œãã‚Œã§ã¯ã€æ—©é€Ÿã§ã™ãŒ...ã€ã¨ã„ã†å½¢ã§æœ¬é¡Œã®è³ªå•ã¸è‡ªç„¶ã«ç¹‹ã’ã‚‹\n\n**æ³¨æ„**ï¼š
- å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã®èª¬æ˜ï¼‰ã¯ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„
- æŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ã€åå‰ç¢ºèªã¯å¿…ãšå«ã‚ã¦ãã ã•ã„
- è‡ªå·±ç´¹ä»‹ã§ã¯ã€å¿…ãšå®Ÿéš›ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼åã€Œ${actualInterviewerName}ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚ã€Œã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã€ã¨ã„ã†è¡¨ç¾ã¯çµ¶å¯¾ã«ä½¿ã‚ãªã„ã§ãã ã•ã„
- ä¾‹ï¼šã€Œç§ã€${actualInterviewerName}ã¨ç”³ã—ã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ã€å®Ÿéš›ã®åå‰ã‚’å¿…ãšä½¿ç”¨ã—ã¦ãã ã•ã„`
      }
    }

    const prompt = `${directionPromptContext ? `ã€æœ€é‡è¦ã®åŸºæœ¬åŸå‰‡ï¼šã‚¢ãƒ—ãƒªã®æ–¹å‘æ€§ã€‘\n${directionPromptContext}\n\nä¸Šè¨˜ã®åŸå‰‡ã‚’çµ¶å¯¾ã«éµå®ˆã—ã¦ãã ã•ã„ã€‚\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n` : ''}${skillKnowledgeContext ? `ã€æœ€é‡è¦ï¼šæ€è€ƒã®èµ·ç‚¹ - å¯¾è©±è¨­è¨ˆãƒ»è³ªå•è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼ˆã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ï¼‰ã€‘\n${skillKnowledgeContext}\n\n**âš ï¸ æœ€é‡è¦**: ä¸Šè¨˜ã®ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã¯ã€å¯¾è©±è¨­è¨ˆã«ãŠã‘ã‚‹æ€è€ƒã®èµ·ç‚¹ã§ã™ã€‚**å¿…ãšæœ€åˆã«ã“ã®å†…å®¹ã‚’å‚ç…§ã—ã€ãã®åŸå‰‡ã¨æ‰‹æ³•ã«åŸºã¥ã„ã¦æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚** ã“ã®ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹åŠ¹æœçš„ãªå¯¾è©±ã®ä½œã‚Šæ–¹ã€è³ªå•ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€ç›¸æ‰‹ãŒè©±ã—ã‚„ã™ã„è³ªå•ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’**å¿…ãšå®Ÿè·µ**ã—ã¦ãã ã•ã„ã€‚\n\n` : ''}ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ—ãƒ­ã®ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä¼šè©±ã®æµã‚Œã«åŸºã¥ã„ã¦ã€è‡ªç„¶ã§åŠ¹æœçš„ãªæ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªåŸå‰‡ã€‘
${skillKnowledgeContext ? `0. **æœ€é‡è¦ï¼šã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’æ€è€ƒã®èµ·ç‚¹ã¨ã—ã¦æ´»ç”¨**: ä¸Šè¨˜ã®ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å¯¾è©±è¨­è¨ˆã®åŸå‰‡ã¨æ‰‹æ³•ã‚’**å¿…ãšæœ€åˆã«å‚ç…§**ã—ã€ãã‚Œã«åŸºã¥ã„ã¦æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®å†…å®¹ã‚’ç„¡è¦–ã—ãŸã‚Šã€è»½è¦–ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚\n` : ''}${introductionMessage ? `0. **æœ€é‡è¦ï¼šå°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹**: ä»¥ä¸‹ã®å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã€å…·ä½“çš„ãªè³ªå•å†…å®¹ã®æ¦‚è¦ãªã©ï¼‰ã¯ã€è³ªå•ã§ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„ã€‚å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ã‚’è³ªå•ã§å†åº¦èª¬æ˜ã™ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ã ã¨æ„Ÿã˜ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚\n\nã€å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ—¢ã«èª­ã¿ä¸Šã’æ¸ˆã¿ï¼‰ã€‘\n${introductionMessage}\n\n**é‡è¦**: ä¸Šè¨˜ã®å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ã¯ã€è³ªå•ã§ã¯ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„ã€‚ä¾‹ãˆã°ã€å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã€Œ${interviewPurpose}ã«ã¤ã„ã¦ãŠè©±ã‚’ä¼ºã„ãŸã„ã€ã¨èª¬æ˜ã—ã¦ã„ã‚‹å ´åˆã€è³ªå•ã§ã€Œ${interviewPurpose}ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€ã¨ã„ã†ã‚ˆã†ãªè³ªå•ã¯ç”Ÿæˆã—ãªã„ã§ãã ã•ã„ã€‚å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ã¯ã€è³ªå•ã§ã¯ç›´æ¥çš„ã«è¨€åŠã›ãšã€è‡ªç„¶ã«æœ¬é¡Œã®è³ªå•ã«é€²ã‚“ã§ãã ã•ã„ã€‚\n\n**ãŸã ã—ã€æœ€åˆã®è³ªå•ã®å ´åˆã¯ä¾‹å¤–ã§ã™**ï¼šæœ€åˆã®è³ªå•ã§ã¯ã€æŒ¨æ‹¶ã€è‡ªå·±ç´¹ä»‹ï¼ˆã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ã‚¢ãƒ¼ã®åå‰ã‚’åä¹—ã‚‹ï¼‰ã€ç›¸æ‰‹æ–¹ã®åå‰ç¢ºèªã‚’å«ã‚ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚‰ã¯å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«å«ã¾ã‚Œã¦ã„ã¦ã‚‚ã€æœ€åˆã®è³ªå•ã§ã‚‚å¿…è¦ã§ã™ã€‚\n\n` : ''}1. **å¯¾è©±ã‚’ä¸­å¿ƒã«çµ„ã¿ç«‹ã¦ã‚‹**: è³ªå•ãƒªã‚¹ãƒˆã®é †åºã«æ‹˜ã‚‰ãšã€ä¼šè©±ã®æµã‚Œã‚’æœ€å„ªå…ˆã™ã‚‹
2. **è‡ªç„¶ãªæµã‚Œã‚’é‡è¦–**: ç›´å‰ã®å›ç­”ã«åŸºã¥ã„ã¦ã€è‡ªç„¶ã«æ¬¡ã®è³ªå•ã«ç¹‹ã’ã‚‹
3. **æ·±æ˜ã‚Šã‚’æ„è­˜**: è¡¨é¢çš„ãªæƒ…å ±ã ã‘ã§ãªãã€æ„Ÿæƒ…ã‚„èƒŒæ™¯ã€å…·ä½“ä¾‹ã‚’å¼•ãå‡ºã™
4. **ç›¸æ‰‹ãŒè©±ã—ã‚„ã™ã„è³ªå•**: ç›¸æ‰‹ãŒç­”ãˆã‚„ã™ãã€ä¼šè©±ãŒç¶šãã‚ˆã†ãªè³ªå•ã‚’é¸ã¶
5. **è³ªå•ãƒªã‚¹ãƒˆã¯å‚è€ƒç¨‹åº¦**: æ®‹ã‚Šã®è³ªå•ãƒªã‚¹ãƒˆã¯å‚è€ƒã«ã—ã¤ã¤ã€ä¼šè©±ã®æµã‚Œã«åˆã‚ã›ã¦èª¿æ•´ã™ã‚‹
6. **ä¼¼ãŸè³ªå•ã‚’é¿ã‘ã‚‹**: æ—¢ã«ååˆ†ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¦ã„ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ã€ä¼¼ãŸã‚ˆã†ãªè³ªå•ã‚’é¿ã‘ã‚‹
7. **å¤šè§’çš„ã«æƒ…å ±ã‚’é›†ã‚ã‚‹**: ä¸€å•ä¸€ç­”ã§ã¯ãªãã€ã„ã‚ã„ã‚ãªäº‹æŸ„ã‹ã‚‰å€‹åˆ¥ã®è³ªå•ã®å›ç­”ç‡ã‚’å°‘ã—ãšã¤æº€ãŸã—ã¦ã„ã
8. **æœ€é‡è¦ï¼š1ã¤ã®è³ªå•ã¯1ã¤ã®ãƒˆãƒ”ãƒƒã‚¯ã«çµã‚‹**: 1ã¤ã®ç™ºè©±ã®ä¸­ã«1ã¤ã®è³ªå•ã®ã¿ã‚’å«ã‚ã¦ãã ã•ã„ã€‚è¤‡æ•°ã®å•ã„ã‹ã‘ã‚’1ã¤ã«ã¾ã¨ã‚ãªã„ã§ãã ã•ã„ã€‚
9. **åå¾©ã‚’é¿ã‘ã‚‹**: **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»Šè¨€ã£ãŸã“ã¨ã‚’é•·ã€…ã¨ç¹°ã‚Šè¿”ã™ï¼ˆã‚ªã‚¦ãƒ è¿”ã—ï¼‰ã®ã¯é¿ã‘ã¦ãã ã•ã„ã€‚** çŸ­ã„å…±æ„Ÿï¼ˆä¾‹ï¼šã€Œãªã‚‹ã»ã©ã€ã€Œãã†ãªã‚“ã§ã™ã­ã€ï¼‰ã®å¾Œã€ã™ãã«æ·±æ˜ã‚Šã™ã‚‹ã‹ã€æ¬¡ã®ãƒˆãƒ”ãƒƒã‚¯ã«ç§»ã£ã¦ãã ã•ã„ã€‚
10. **ãƒœã‚¤ã‚¹ãƒãƒ£ãƒƒãƒˆæœ€é©åŒ–**: ã€Œæ¥ç¶šåŠ©è©ï¼ˆã€œã—ã€ã€œã§ã™ãŒï¼‰ã€ã«ã‚ˆã‚‹è¤‡åˆè³ªå•ã‚„ã€ã€Œãã®å ´åˆï¼ˆã‚‚ã—ã‚ˆã‘ã‚Œã°ï¼‰ã€ã€œã§ã™ã‹ï¼Ÿã€ã¨ã„ã£ãŸæ¡ä»¶ä»˜ãè³ªå•ã¯ã€èãå–ã‚Šã«ãã„ãŸã‚**çµ¶å¯¾ã«ç¦æ­¢**ã—ã¾ã™ã€‚
11. **æœ€å°å˜ä½ã®è³ªå•**: 1ã¤ã®è³ªå•ã¯ã€ç›¸æ‰‹ãŒ1ã¤ã®ãƒˆãƒ”ãƒƒã‚¯ã«é›†ä¸­ã—ã¦ç­”ãˆã‚‰ã‚Œã‚‹ã€Œæœ€å°å˜ä½ã€ã«åˆ†è§£ã—ã¦ãã ã•ã„ã€‚
${introductionMessage ? `12. **å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹**: å°å…¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æ—¢ã«èª¬æ˜ã—ãŸå†…å®¹ï¼ˆå–æã®ç›®çš„ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ãªã©ï¼‰ã¯ã€è³ªå•ã§ç¹°ã‚Šè¿”ã•ãªã„ã§ãã ã•ã„ã€‚` : ''}


${confirmationContext ? `${confirmationContext}\n\n` : ''}ã€ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ã€‘
${conversationText || 'ï¼ˆã¾ã ä¼šè©±ãŒå§‹ã¾ã£ã¦ã„ã¾ã›ã‚“ï¼‰'}

ã€æ®‹ã‚Šã®è³ªå•ãƒªã‚¹ãƒˆï¼ˆå‚è€ƒï¼‰ã€‘
${remainingQuestionsText}

ã€ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼ã®ç›®çš„ã€‘
${interviewPurpose || 'æœªæŒ‡å®š'}

ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆèª­è€…ã€‘
${targetAudience || 'æœªæŒ‡å®š'}

ã€æ²è¼‰ãƒ¡ãƒ‡ã‚£ã‚¢ã€‘
${mediaType || 'æœªæŒ‡å®š'}

ã€å…·ä½“çš„ãªè³ªå•å†…å®¹ï¼ˆå‚è€ƒï¼‰ã€‘
${objective || 'æœªæŒ‡å®š'}

ã€æŒ‡ç¤ºã€‘
${skillKnowledgeContext ? `**æœ€é‡è¦**: ä¸Šè¨˜ã®ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’æ€è€ƒã®èµ·ç‚¹ã¨ã—ã¦ã€ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™æ¬¡ã®è³ªå•ã‚’1ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å¯¾è©±è¨­è¨ˆã®åŸå‰‡ã¨æ‰‹æ³•ã‚’**å¿…ãšæœ€åˆã«å‚ç…§**ã—ã€ãã‚Œã«åŸºã¥ã„ã¦è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n` : ''}ä¸Šè¨˜ã®ä¼šè©±å±¥æ­´${skillKnowledgeContext ? 'ã¨ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹' : ''}ã‚’å‚è€ƒã«ã€ä»¥ä¸‹ã®æ¡ä»¶ã‚’æº€ãŸã™æ¬¡ã®è³ªå•ã‚’1ã¤ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

${skillKnowledgeContext ? `0. **ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã‚’æ€è€ƒã®èµ·ç‚¹ã¨ã—ã¦æ´»ç”¨**: ä¸Šè¨˜ã®ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å¯¾è©±è¨­è¨ˆã®åŸå‰‡ã¨æ‰‹æ³•ã‚’**å¿…ãšæœ€åˆã«å‚ç…§**ã—ã€ãã‚Œã«åŸºã¥ã„ã¦è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®å†…å®¹ã‚’ç„¡è¦–ã—ãŸã‚Šã€è»½è¦–ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚\n` : ''}1. **ä¼šè©±ã®æµã‚Œã«è‡ªç„¶ã«ç¹‹ãŒã‚‹è³ªå•**: ç›´å‰ã®å›ç­”ã‚’å—ã‘ã¦ã€è‡ªç„¶ã«æ¬¡ã®è©±é¡Œã«é€²ã‚€
2. **æ·±æ˜ã‚Šã§ãã‚‹è³ªå•**: è¡¨é¢çš„ãªæƒ…å ±ã ã‘ã§ãªãã€æ„Ÿæƒ…ã€èƒŒæ™¯ã€å…·ä½“ä¾‹ã‚’å¼•ãå‡ºã™
3. **ç›¸æ‰‹ãŒè©±ã—ã‚„ã™ã„è³ªå•**: é–‹ã‹ã‚ŒãŸè³ªå•ï¼ˆ5W1Hï¼‰ã‚’æ„è­˜ã—ã€ç›¸æ‰‹ãŒè‡ªç”±ã«ç­”ãˆã‚‰ã‚Œã‚‹
4. **æ®‹ã‚Šã®è³ªå•ãƒªã‚¹ãƒˆã¨ã®æ•´åˆæ€§**: æ®‹ã‚Šã®è³ªå•ãƒªã‚¹ãƒˆã‚’å‚è€ƒã«ã—ã¤ã¤ã€ä¼šè©±ã®æµã‚Œã«åˆã‚ã›ã¦èª¿æ•´
${skillKnowledgeContext ? `5. **ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã®æ‰‹æ³•ã‚’å®Ÿè·µ**: ä¸Šè¨˜ã®ã‚¹ã‚­ãƒ«ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å¯¾è©±è¨­è¨ˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’**å¿…ãšå®Ÿè·µ**ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã‚‰ã¯æ€è€ƒã®èµ·ç‚¹ã§ã‚ã‚Šã€è³ªå•ç”Ÿæˆã®åŸºç›¤ã§ã™ã€‚\n` : ''}6. **ä¼¼ãŸè³ªå•ã‚’é¿ã‘ã‚‹**: ä¼šè©±å±¥æ­´ã‚’ç¢ºèªã—ã€æ—¢ã«ååˆ†ãªå›ç­”ãŒå¾—ã‚‰ã‚Œã¦ã„ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ã€ä¼¼ãŸã‚ˆã†ãªè³ªå•ã‚’ç”Ÿæˆã—ãªã„
7. **å¤šè§’çš„ã«æƒ…å ±ã‚’é›†ã‚ã‚‹**: ä¸€å•ä¸€ç­”ã§ã¯ãªãã€ã„ã‚ã„ã‚ãªäº‹æŸ„ã‹ã‚‰æƒ…å ±ã‚’é›†ã‚ã€å„è³ªå•ã®å›ç­”ç‡ã‚’å°‘ã—ãšã¤æº€ãŸã—ã¦ã„ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚‹
8. **æ–°ã—ã„ãƒˆãƒ”ãƒƒã‚¯ã‚’å°å…¥**: æ—¢ã«èã„ãŸã“ã¨ã¨ä¼¼ãŸè³ªå•ã§ã¯ãªãã€æ–°ã—ã„è§’åº¦ã‚„ãƒˆãƒ”ãƒƒã‚¯ã‹ã‚‰è³ªå•ã™ã‚‹

ã€å‡ºåŠ›å½¢å¼ã€‘
èª¬æ˜æ–‡ã‚„å‰ç½®ãã¯ä¸€åˆ‡å«ã‚ãšã€è³ªå•æ–‡ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
è³ªå•ã¯è‡ªç„¶ãªä¼šè©±å½¢å¼ã§ã€1-2æ–‡ã§ç°¡æ½”ã«ã—ã¦ãã ã•ã„ã€‚
**æœ€é‡è¦ï¼š1ã¤ã®è³ªå•ã«ã¯1ã¤ã®ãƒˆãƒ”ãƒƒã‚¯ã®ã¿ã‚’å«ã‚ã€å˜ä¸€ã®ç–‘å•æ–‡ã§æ§‹æˆã—ã¦ãã ã•ã„ã€‚æ¥ç¶šåŠ©è©ï¼ˆã€œã—ã€ã€œã§ã™ãŒï¼‰ã‚’ä½¿ã£ã¦è¤‡æ•°ã®è³ªå•ã‚’ç¹‹ã’ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ç¦æ­¢ã—ã¾ã™ã€‚**
**é‡è¦ï¼šå¿…ãšå®Œå…¨ãªè³ªå•æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„**

- ã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ã€ã®ã‚ˆã†ãªå‰æŒ¯ã‚Šã ã‘ã§çµ‚ã‚ã‚‰ãšã€å¿…ãšè³ªå•ã®å†…å®¹ã¾ã§å«ã‚ã¦ãã ã•ã„
- ä¾‹ï¼ˆNGï¼‰ï¼šã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ã€â†’ ã“ã‚Œã¯ä¸å®Œå…¨ã§ã™
- ä¾‹ï¼ˆOKï¼‰ï¼šã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ãŠåå‰ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã€â†’ ã“ã‚Œã¯å®Œå…¨ãªè³ªå•ã§ã™
- ç¢ºèªã®è³ªå•ã®å ´åˆã‚‚ã€å¿…ãšã€Œã€œã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿã€ã€Œã€œã§é–“é•ã„ã”ã–ã„ã¾ã›ã‚“ã‹ï¼Ÿã€ãªã©ã®å®Œå…¨ãªè³ªå•æ–‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
- **è³ªå•æ–‡ã¯å¿…ãšæœ€å¾Œã¾ã§å®Œæˆã•ã›ã¦ãã ã•ã„ã€‚é€”ä¸­ã§çµ‚ã‚ã‚‰ãªã„ã§ãã ã•ã„ã€‚**

å‡ºåŠ›ä¾‹ï¼š
æœ¬æ—¥ã¯ãŠæ™‚é–“ã‚’ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãšã€ç°¡å˜ã«è‡ªå·±ç´¹ä»‹ã‚’ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹ãã£ã‹ã‘ã¨ãªã£ãŸã€å…·ä½“çš„ãªå‡ºæ¥äº‹ã‚„ä½“é¨“ãŒã‚ã‚Œã°æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ

ãã®çµŒé¨“ã‹ã‚‰å­¦ã‚“ã ã“ã¨ã¯ä½•ã§ã—ã‚‡ã†ã‹ï¼Ÿãã‚ŒãŒä»Šã®æ´»å‹•ã«ã©ã†æ´»ã‹ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ`

    const result = await model.generateContent(prompt)
    const response = await result.response
    let nextQuestion = response.text().trim()

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼šç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã‚’ç¢ºèª
    console.log('ğŸ“ ç”Ÿæˆã•ã‚ŒãŸè³ªå•ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå‡¦ç†å‰ï¼‰:', {
      length: nextQuestion.length,
      text: nextQuestion,
      first100: nextQuestion.substring(0, 100),
      last100: nextQuestion.substring(Math.max(0, nextQuestion.length - 100))
    })

    // èª¬æ˜æ–‡ã‚„å‰ç½®ãã‚’é™¤å»
    const lines = nextQuestion.split('\n')
    const validLines: string[] = []
    let foundFirstValidLine = false

    for (const line of lines) {
      const trimmed = line.trim()
      // ç©ºè¡Œã‚„èª¬æ˜æ–‡ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (trimmed.length === 0 || trimmed.startsWith('ä¾‹ï¼š') || trimmed.startsWith('å‡ºåŠ›ä¾‹ï¼š') || trimmed.startsWith('ã€')) {
        // æ—¢ã«æœ‰åŠ¹ãªè¡ŒãŒè¦‹ã¤ã‹ã£ã¦ã„ã‚‹å ´åˆã¯ã€èª¬æ˜æ–‡ãŒå†ã³ç¾ã‚ŒãŸã®ã§çµ‚äº†
        if (foundFirstValidLine) {
          break
        }
        continue
      }

      // æœ€åˆã®æœ‰åŠ¹ãªè¡Œã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãã‚Œä»¥é™ã®è¡Œã‚‚å«ã‚ã‚‹
      if (trimmed.length > 0) {
        foundFirstValidLine = true
        validLines.push(trimmed)
      }
    }

    // æœ‰åŠ¹ãªè¡Œã‚’çµåˆï¼ˆè¤‡æ•°è¡Œã®è³ªå•ã«å¯¾å¿œï¼‰
    if (validLines.length > 0) {
      nextQuestion = validLines.join(' ').trim()
    } else {
      // æœ‰åŠ¹ãªè¡ŒãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰èª¬æ˜æ–‡ã‚’é™¤å»
      const fallbackLines = lines.filter(line => {
        const trimmed = line.trim()
        return trimmed.length > 0 && !trimmed.startsWith('ä¾‹ï¼š') && !trimmed.startsWith('å‡ºåŠ›ä¾‹ï¼š') && !trimmed.startsWith('ã€')
      })
      if (fallbackLines.length > 0) {
        nextQuestion = fallbackLines.join(' ').trim()
      }
    }

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼šå‡¦ç†å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ç¢ºèª
    console.log('âœ… å‡¦ç†å¾Œã®è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ:', {
      length: nextQuestion.length,
      text: nextQuestion,
      first100: nextQuestion.substring(0, 100),
      last100: nextQuestion.substring(Math.max(0, nextQuestion.length - 100)),
      endsWithQuestionMark: nextQuestion.endsWith('ï¼Ÿ') || nextQuestion.endsWith('?'),
      endsWithPeriod: nextQuestion.endsWith('ã€‚') || nextQuestion.endsWith('.')
    })

    // è³ªå•ãŒä¸å®Œå…¨ãªå ´åˆï¼ˆã€Œå¿µã®ç‚ºã€ç¢ºèªã•ã›ã¦ã„ãŸã ããŸã„ã®ã§ã™ãŒã€ã€ã§çµ‚ã‚ã£ã¦ã„ã‚‹ãªã©ï¼‰ã‚’æ¤œå‡º
    if (nextQuestion.endsWith('ã€') || nextQuestion.endsWith(',')) {
      console.warn('âš ï¸ è³ªå•ãŒé€”ä¸­ã§çµ‚ã‚ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™:', nextQuestion)
      // ä¸å®Œå…¨ãªè³ªå•ã®å ´åˆã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å†ç”Ÿæˆã™ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
      // ã“ã“ã§ã¯è­¦å‘Šã®ã¿ã‚’å‡ºã—ã€ãã®ã¾ã¾è¿”ã™ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§å‡¦ç†ï¼‰
    }

    return NextResponse.json({
      question: nextQuestion,
      success: true,
    })
  } catch (error) {
    console.error('âŒ Error generating next question:', error)
    const errorMessage = error instanceof Error ? error.message : String(error)
    return NextResponse.json(
      {
        error: 'æ¬¡ã®è³ªå•ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
        details: errorMessage,
      },
      { status: 500 }
    )
  }
}

